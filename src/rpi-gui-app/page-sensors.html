<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/google-chart/google-chart.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="page-sensors">
  <template>
    <style>
      :host {
        width: 100%;
      }
      paper-card {
        width: 100%
      }
      google-chart {
        width: 100%;
      }
      .flex-center-justified {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-center);
        margin-bottom: 1em;
      }
    </style>

    <iron-ajax
      id="req"
      auto
      url="/api/temperatures"
      handle-as="json"
      on-request="handleRequest"
      on-response="handleResponse"
      bubbles="true"
      debounce-duration="300"></iron-ajax>

    <paper-card heading="Sensoren">
      <div class="flex-center-justified">
        <paper-button  raised on-click="refresh">Aktualisieren</paper-button>
        <paper-spinner id="spinner"></paper-spinner>
      </div>
      <google-chart
        id='chartTemp'
        type='line'
        options='{"title": "Temperatur", "pointSize": 2, "explorer": {}}'
        cols='[{"label":"Zeitpunkt", "type":"datetime"}, {"label":"Â°C", "type":"number"}]'>
      </google-chart>
      <google-chart
        id='chartHumid'
        type='line'
        options='{"title": "Luftfeuchtigkeit", "pointSize": 2, "explorer": {}}'
        cols='[{"label":"Zeitpunkt", "type":"datetime"}, {"label":"%RH", "type":"number"}]'>
      </google-chart>
    </paper-card>

  </template>
  <script>
    Polymer({
      is: 'page-sensors',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'iron-resize': '_onIronResize'
      },

      _onIronResize: function() {
        this.$.chartTemp.redraw();
        this.$.chartHumid.redraw();
      },

      handleRequest: function(evt) {
        this.$.spinner.active = true;
      },

      handleResponse: function(evt) {
        var data = evt.detail.response,
            tempData = [],
            humidData = [];

        for(var x in data) {
          tempData.push([
            new Date(data[x].timestamp),
            data[x].temperature,
          ]);
          humidData.push([
            new Date(data[x].timestamp),
            data[x].humidity
          ]);
        }

        this.$.chartTemp.rows = tempData;
        this.$.chartHumid.rows = humidData;

        this.$.spinner.active = false;
      },

      refresh: function() {
        this.$.req.generateRequest();
      }
    });
  </script>
</dom-module>
